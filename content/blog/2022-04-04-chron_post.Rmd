---
date: 2022-04-01
title: The {chronicler} package, an implementation of the logger monad in R
tags: [R]
menu:
main:
  parent: Blog
  identifier: /blog/chronicle
  weight: 1
---


<div style="text-align:center;">
<a href="https://wiki.haskell.org/Monad_laws">
<img src="/img/monads.jpg" title = "Believe me, the reward is not so great without the struggle. - Wilma Rudolph"></a>
</div>

[Back in February](https://www.brodrigues.co/blog/2022-02-18-loudly/) I discussed a package I was working on
which allowed users to add logging to function calls. I named the package `{loudly}` but decided
to rename it to [`{chronicler}`](https://github.com/b-rodrigues/chronicler).

I have been working on it for the past few weeks, and I think that a CRAN release could happen soon.

## Introduction

So what does `{chronicler}` do? `{chronicler}` allows you do decorate functions, so that they
provide enhanced output:


```{r example}
library(chronicler)

r_sqrt <- record(sqrt)

a <- r_sqrt(1:5)

```

Object `a` is now an object of class `chronicle`. Let’s print `a` to the terminal:

```{r}
a
```

as the output says, `a` is an object of type `chronicle`. Let’s use `read_log()` as suggested:

```{r}
read_log(a)
```

The log tells us how `a` was built, and it's especially useful for objects that are the result
of many function calls:


```{r}
r_sqrt <- record(sqrt)
r_exp <- record(exp)
r_mean <- record(mean)

b <- 1:10 |>
  r_sqrt() |>
  bind_record(r_exp) |>
  bind_record(r_mean)

```

The log gives all the details:

```{r}
read_log(b)
```

The end result, or what is called `value` can be obtained using `pick()` (you could also use `a$value`):

```{r}
pick(a, "value")
pick(b, "value")
```

## Composing decorated functions

`bind_record()` is used to pass the output from one decorated function to the next:

```{r}
suppressPackageStartupMessages(
  library(dplyr)
)

r_group_by <- record(group_by)
r_select <- record(select)
r_summarise <- record(summarise)
r_filter <- record(filter)

output <- starwars %>%
  r_select(height, mass, species, sex) %>%
  bind_record(r_group_by, species, sex) %>%
  bind_record(r_filter, sex != "male") %>%
  bind_record(r_summarise,
              mass = mean(mass, na.rm = TRUE)
              )

```

```{r}
read_log(output)
```

The value can then be saved in a new variable:

```{r}
(my_df <- pick(output, "value"))
```

You can save the `output` object with `saveRDS()` and share it; your colleague can then read the log
to learn how the object was created.

This package also ships with a dedicated pipe, `%>=%` which you can use instead of `bind_record()`:

```{r}
output_pipe <- starwars %>%
  r_select(height, mass, species, sex) %>=%
  r_group_by(species, sex) %>=%
  r_filter(sex != "male") %>=%
  r_summarise(mass = mean(mass, na.rm = TRUE))

```

```{r}
pick(output_pipe, "value")
```

## Condition handling

By default, errors and warnings get caught and composed in the log:

```{r}
errord_output <- starwars %>%
  r_select(height, mass, species, sex) %>=%
  r_group_by(species, sx) %>=% # typo, "sx" instead of "sex"
  r_filter(sex != "male") %>=%
  r_summarise(mass = mean(mass, na.rm = TRUE))

```

```{r}
errord_output
```

Reading the log tells you which function failed, and with which error message:

```{r}
read_log(errord_output)
```

It is also possible to only capture errors, or catpure errors, warnings and messages using
the `strict` parameter of `record()`

```{r}
# Only errors:

r_sqrt <- record(sqrt, strict = 1)

# Nothing will be captured here, since sqrt(-10) returns a NA and a warning
r_sqrt(-10) |>
  read_log()

# Errors and warnings:

r_sqrt <- record(sqrt, strict = 2)

# The warning gets captured
r_sqrt(-10) |>
  read_log()

# Errors, warnings and messages

my_f <- function(x){
  message("this is a message")
  10
}

record(my_f, strict = 3)(10) |>
                         read_log()

```

## Advanced logging

You can provide a function to `record()`, which will be evaluated on the output. This makes it possible
to, for example, monitor the size of a data frame throughout the pipeline. In the example below I 
provide `dim()`, which will return the dimensions of the data frame, as an argument to `record()`:

```{r}
r_group_by <- record(group_by)
r_select <- record(select, .g = dim)
r_summarise <- record(summarise, .g = dim)
r_filter <- record(filter, .g = dim)

output_pipe <- starwars %>%
  r_select(height, mass, species, sex) %>=%
  r_group_by(species, sex) %>=%
  r_filter(sex != "male") %>=%
  r_summarise(mass = mean(mass, na.rm = TRUE))

```

The `$log_df` element of a `chronicle` object contains detailed information. In most cases you
don't need to worry about it:

```{r}
pick(output_pipe, "log_df")
```

but if you want to look at the output of `.g`, then you have to grab it and see:

```{r}
# I coerce it to a data.frame just for the output here on my blog, to make the column `g` readable
as.data.frame(output_pipe$log_df[, c("function", "g")])
```

We can see that the dimension of the dataframe was (87, 4) after the call to `select()`, (23, 4)
after the call to `filter()` and finally (9, 3) after the call to `summarise()`.

## Monads

This package implements a logger monad. I might talk about monads in the future, but probably in a 
video; if you don't know what monads are, don't worry, no one really knows. Legend has it that to
truly understand what monads are you have to have a PhD in computer science and have been born in
the former Soviet Union. But to make things simple, you can think of a monad as a way to:

- embelish functions to provide additional output without having to touch the function's core behaviour
- a way to compose these functions and work with the embelished outputs (also called monadic values)
- monadic values are basically containers that contain the actual value of the function evaluated on its inputs and something else (here, a log)

Monads are quite useful in some programming languanges, like Haskell. Not so much in R, but I think
that the logger monad I propose here can be quite useful. So let me know if you find it useful or if
you have suggestions!

You can install `{chronicler}` from its [github repo](https://github.com/b-rodrigues/chronicler).

Hope you enjoyed! If you found this blog post useful, you might want to follow 
me on [twitter](https://www.twitter.com/brodriguesco) for blog post updates and 
[buy me an espresso](https://www.buymeacoffee.com/brodriguesco) or [paypal.me](https://www.paypal.me/brodriguesco), or buy my ebook on [Leanpub](https://leanpub.com/modern_tidyverse).
You can also watch my videos on [youtube](https://www.youtube.com/c/BrunoRodrigues1988/).
So much content for you to consoom!

<style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#272b30 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#82518c !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/brodriguesco"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me an Espresso"><span style="margin-left:5px">Buy me an Espresso</span></a>
