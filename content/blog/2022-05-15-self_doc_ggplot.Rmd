---
date: 2022-05-15
title: Self-documenting {ggplot}s thanks to the power of monads!
tags: [R]
menu:
main:
  parent: Blog
  identifier: /blog/self_doc_ggplots
  weight: 1
---


<div style="text-align:center;">
<a href="https://www.youtube.com/watch?v=I8LbkfSSR58&list=PLbgaMIhjbmEnaH_LTkxLI7FMa2HsnawM_">
<img src="/img/monoids_endofunctors.jpg" title = "How it feels to implement your own monad"></a>
</div>

Hey kid, fancy some self-documenting `{ggplots}` like this one:

```{r, echo = FALSE}
library(ggplot2)
library(chronicler)

r_ggplot <- ggrecord(ggplot)
r_geom_point <- ggrecord(geom_point)
r_labs <- ggrecord(labs)

a <- r_ggplot(mtcars) %>+%
  r_geom_point(aes(y = mpg, x = hp)) %>+%
  r_labs(title = "Self-documenting ggplot!\nLook at the bottom right",
         caption = "This is an example caption")

a <- document_gg(a)
pick(a, "value")

```

Just read on!


I've been working hard on a package that I've called `{chronicler}` (read my post on it
[here](https://www.brodrigues.co/blog/2022-04-04-chron_post/)) which allows you to
attach a log to the objects you create, thus making it easy to know how some data (for example)
has been created. Here's a quick example and intro to the main features:

```{r}
suppressPackageStartupMessages(
  library(dplyr)
)
library(chronicler)

# record() decorates functions so they provide enriched output
r_group_by <- record(group_by)
r_select <- record(select)
r_summarise <- record(summarise)
r_filter <- record(filter)

output_pipe <- starwars %>%
  r_select(height, mass, species, sex) %>=% # <- this is a special pipe operator to handle `chronicle` objects
  r_group_by(species, sex) %>=%
  r_filter(sex != "male") %>=%
  r_summarise(mass = mean(mass, na.rm = TRUE))
```

`output_pipe` not only has the result of all the `{dplyr}` operations, but also carries a log
with it. Let's print the object:

```{r}
output_pipe
```

Accessing the value is possible with `pick("value")`:

```{r}
pick(output_pipe, "value")
```
 
and you can read the log with `read_log()`:

```{r}
read_log(output_pipe)
```

If you want to understand how this works, I suggest you read the blog post I linked above but also
[this one](https://www.brodrigues.co/blog/2022-04-11-monads/), where I explain the nitty gritty,
theoretical details behind what `{chronicler}` does. To make a long story short, `{chronicler}`
uses an advanced functional programming concept called a monad. And using the power of monads,
I can now make self-documenting `{ggplot2}` graphs.

The idea was to be able to build a plot in a way similar to how I built that dataset just above,
and have a log of how it was created attached to it. The issue is that the function that 
*transforms* functions to `chronicler` functions, `record()`, does not work on `{ggplot2}` functions.

This is because the way you create `{ggplot2}` graphs is by adding layers on top of each other:

```{r}
library(ggplot2)

ggplot(mtcars) +
  geom_point(aes(mpg, hp))
```

The `+` here acts as a way to "add" the `geom_point(mpg, hp)` layer on top of the `ggplot(mtcars)` layer.
I remember reading some tweets, quite some time ago, from people asking why `%>%` couldn't work with
`{ggplot2}` and if Hadley Wickham, the developer of `{ggplot2}`, was considering making something like this
work:


```{r, eval = FALSE}
ggplot(mtcars) %>%
  geom_point(aes(mpg, hp))
```

because people kept forgetting using `+` and kept using `%>%`. The thing is, `%>%` and `+` do very
different things. `%>%` takes its first argument and passes it as the first argument of its second
argument, in other words this:

```{r, eval = FALSE}
a %>% f(b)
```

is exactly the same as:

```{r, eval = FALSE}
f(a, b)
```

This is not what `{ggplot2}` functions do. When you call `+` on `{ggplot2}` objects, this is NOT what happens:

```{r, eval = FALSE}
geom_point(ggplot(mtcars), aes(mpg, hp))
```

So that's why `%>%` cannot be used with `{ggplot2}` functions, and that's also why the functions I developed
in `{chronicle}` could not handle `{ggplot2}` functions either. So I had to provide new functions. The first
function I developed is called `ggrecord()` and it decorates `{ggplot2}` functions:

```{r}
r_ggplot <- ggrecord(ggplot)
r_geom_point <- ggrecord(geom_point)
r_labs <- ggrecord(labs)
```

Now the output of these functions are not `ggplot` objects anymore, but chronicle objects. So to make 
layering them possible, I also needed to rewrite `+`. I called my rewritten `+` like this: `%>+%`:

```{r}
a <- r_ggplot(mtcars) %>+%
  r_geom_point(aes(y = mpg, x = hp)) %>+%
  r_labs(title = "Self-documenting ggplot!\nLook at the bottom right",
         caption = "This is an example caption")
```

Let's first take a look at `a`:

```{r}
a
```

As before expected, `a` is now an object of type `{chronicle}`, where its "value" is a `ggplot` object.
But where is the self-documenting part?
For this, you use the last piece of the puzzle, `document_gg()`:

```{r}
document_gg(a)
```

The caption now contains the log of the plot, making it easily reproducible!

This is still in very early development, but if you want to try it out, you'll need to try the `dev`
branch of [the package](https://github.com/b-rodrigues/chronicler/tree/dev).

Any feedback, comments, ideas, pull requests, more than welcome.

Hope you enjoyed! If you found this blog post useful, you might want to follow 
me on [twitter](https://www.twitter.com/brodriguesco) for blog post updates and 
[buy me an espresso](https://www.buymeacoffee.com/brodriguesco) or [paypal.me](https://www.paypal.me/brodriguesco), or buy my ebook on [Leanpub](https://leanpub.com/modern_tidyverse).
You can also watch my videos on [youtube](https://www.youtube.com/c/BrunoRodrigues1988/).
So much content for you to consoom!

<style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#272b30 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#82518c !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/brodriguesco"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me an Espresso"><span style="margin-left:5px">Buy me an Espresso</span></a>
